# PostgreSQL â†’ Databases connector mapping
# Filename (databases.yaml) determines which app schema this implements

actions:
  query:
    label: "Execute SQL query"
    sql:
      # Use |raw modifier to skip SQL escaping - the AI provides complete SQL queries
      query: "{{params.sql | raw}}"
      format: json
    response:
      mapping:
        rows: "."
        row_count: "length(.)"

  tables:
    label: "List tables"
    readonly: true
    sql:
      query: |
        SELECT table_name as name
        FROM information_schema.tables 
        WHERE table_schema = 'public'
          AND table_type = 'BASE TABLE'
        ORDER BY table_name
      format: json
    response:
      mapping: "[].name"

  describe:
    label: "Describe table"
    readonly: true
    sql:
      query: |
        SELECT 
          c.column_name as name,
          c.data_type as type,
          c.is_nullable = 'YES' as nullable,
          c.column_default as default,
          CASE WHEN pk.column_name IS NOT NULL THEN true ELSE false END as primary_key
        FROM information_schema.columns c
        LEFT JOIN (
          SELECT ku.column_name
          FROM information_schema.table_constraints tc
          JOIN information_schema.key_column_usage ku
            ON tc.constraint_name = ku.constraint_name
          WHERE tc.constraint_type = 'PRIMARY KEY'
            AND tc.table_name = '{{params.table}}'
        ) pk ON c.column_name = pk.column_name
        WHERE c.table_name = '{{params.table}}'
          AND c.table_schema = 'public'
        ORDER BY c.ordinal_position
      format: json
    response:
      mapping:
        name: "'{{params.table}}'"
        schema: "'public'"
        columns: "."

# Copilot Money â†’ Finance tool mapping

actions:
  list:
    readonly: true
    sql:
      query: |
        SELECT 
          id,
          name as merchant,
          amount,
          date(date) as date,
          category_id,
          pending,
          recurring,
          user_reviewed as reviewed,
          user_note as note
        FROM Transactions 
        WHERE (user_deleted = 0 OR user_deleted IS NULL)
        ORDER BY date DESC 
        LIMIT {{params.limit | default: 30}}

  get:
    readonly: true
    sql:
      query: |
        SELECT 
          id,
          name as merchant,
          original_name,
          name_override,
          amount,
          date(date) as date,
          category_id,
          plaid_category_strings,
          type,
          pending,
          recurring,
          recurring_id,
          user_reviewed as reviewed,
          user_note as note,
          user_deleted as hidden
        FROM Transactions 
        WHERE id = '{{params.id}}'
    response:
      mapping: ".[0]"

  search:
    readonly: true
    sql:
      query: |
        SELECT 
          id,
          name as merchant,
          amount,
          date(date) as date,
          category_id,
          user_reviewed as reviewed
        FROM Transactions 
        WHERE name LIKE '%{{params.query}}%'
          AND (user_deleted = 0 OR user_deleted IS NULL)
        ORDER BY date DESC 
        LIMIT {{params.limit | default: 30}}

  unreviewed:
    readonly: true
    sql:
      query: |
        SELECT 
          id,
          name as merchant,
          amount,
          date(date) as date,
          category_id,
          plaid_category_strings
        FROM Transactions 
        WHERE (user_reviewed = 0 OR user_reviewed IS NULL)
          AND (user_deleted = 0 OR user_deleted IS NULL)
          AND date >= date('now', '-{{params.days | default: 30}} days')
          AND type = 'regular'
        ORDER BY date DESC 
        LIMIT {{params.limit | default: 50}}

  spending_by_month:
    readonly: true
    sql:
      query: |
        SELECT 
          strftime('%Y-%m', date) as month,
          COUNT(*) as transaction_count,
          ROUND(ABS(SUM(amount)), 2) as total_spending
        FROM Transactions 
        WHERE amount < 0 
          AND date >= date('now', '-{{params.months | default: 3}} months')
          AND type = 'regular'
          AND (user_deleted = 0 OR user_deleted IS NULL)
        GROUP BY month 
        ORDER BY month DESC

  spending_by_merchant:
    readonly: true
    sql:
      query: |
        SELECT 
          name as merchant,
          ROUND(ABS(SUM(amount)), 2) as total_spending,
          COUNT(*) as transaction_count,
          date(MIN(date)) as first_seen,
          date(MAX(date)) as last_seen
        FROM Transactions 
        WHERE amount < 0 
          AND date >= date('now', '-{{params.months | default: 3}} months')
          AND type = 'regular'
          AND (user_deleted = 0 OR user_deleted IS NULL)
        GROUP BY name 
        ORDER BY total_spending DESC
        LIMIT {{params.limit | default: 25}}

  spending_by_category:
    readonly: true
    sql:
      query: |
        SELECT 
          category_id,
          ROUND(ABS(SUM(amount)), 2) as total_spending,
          COUNT(*) as transaction_count
        FROM Transactions 
        WHERE amount < 0 
          AND date >= date('now', '-{{params.months | default: 3}} months')
          AND type = 'regular'
          AND (user_deleted = 0 OR user_deleted IS NULL)
        GROUP BY category_id 
        ORDER BY total_spending DESC

  balances:
    readonly: true
    sql:
      query: |
        SELECT 
          account_id, 
          date, 
          current_balance, 
          available_balance,
          "limit" as credit_limit
        FROM accountDailyBalance 
        WHERE date = (
          SELECT MAX(date) 
          FROM accountDailyBalance adb2 
          WHERE adb2.account_id = accountDailyBalance.account_id
        )

  recategorize:
    sql:
      query: |
        UPDATE Transactions 
        SET category_id = '{{params.category_id}}', 
            user_reviewed = 1 
        WHERE id = '{{params.id}}'
        RETURNING id, name as merchant, category_id, user_reviewed as reviewed
    response:
      mapping: ".[0]"

  add_note:
    sql:
      query: |
        UPDATE Transactions 
        SET user_note = '{{params.note}}'
        WHERE id = '{{params.id}}'
        RETURNING id, name as merchant, user_note as note
    response:
      mapping: ".[0]"

  hide:
    sql:
      query: |
        UPDATE Transactions 
        SET user_deleted = 1 
        WHERE id = '{{params.id}}'
        RETURNING id, name as merchant, user_deleted as hidden
    response:
      mapping: ".[0]"

  unhide:
    sql:
      query: |
        UPDATE Transactions 
        SET user_deleted = 0 
        WHERE id = '{{params.id}}'
        RETURNING id, name as merchant, user_deleted as hidden
    response:
      mapping: ".[0]"

  mark_reviewed:
    sql:
      query: |
        UPDATE Transactions 
        SET user_reviewed = 1 
        WHERE id = '{{params.id}}'
        RETURNING id, name as merchant, user_reviewed as reviewed
    response:
      mapping: ".[0]"

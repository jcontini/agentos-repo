# Pre-commit: Fast validation (~1s)
# - Schema validation (catches malformed YAML)
# - Security checks (catches credential exposure)
# Full integration tests run on pre-push

STAGED_READMES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^connectors/[^/]+/readme\.md$' || true)

if [ -z "$STAGED_READMES" ]; then
  exit 0
fi

ERRORS=0

# === Schema Validation ===
echo "üìã Schema validation..."
APPS=$(echo "$STAGED_READMES" | sed 's|connectors/||' | sed 's|/readme.md||' | tr '\n' ' ')
node tests/scripts/validate-schema.mjs $APPS || ERRORS=$((ERRORS + 1))

# === Security Checks ===
echo ""
echo "üîí Security checks..."

# Check for credential exposure patterns
if echo "$STAGED_READMES" | xargs grep -l '\$AUTH_TOKEN\|\${AUTH_TOKEN}' 2>/dev/null; then
  echo "‚ùå BLOCKED: \$AUTH_TOKEN found - use rest: or graphql: blocks instead"
  ERRORS=$((ERRORS + 1))
fi

if echo "$STAGED_READMES" | xargs grep -l 'curl.*[Aa]uthorization\|wget' 2>/dev/null; then
  echo "‚ùå BLOCKED: curl/wget with auth - use AgentOS executors (rest:, graphql:, sql:)"
  ERRORS=$((ERRORS + 1))
fi

if echo "$STAGED_READMES" | xargs grep -l 'Bearer \$' 2>/dev/null; then
  echo "‚ùå BLOCKED: Bearer token interpolation - AgentOS handles auth automatically"
  ERRORS=$((ERRORS + 1))
fi

if [ $ERRORS -eq 0 ]; then
  echo "‚úÖ All checks passed"
else
  echo ""
  echo "‚ùå Fix $ERRORS error(s) before committing"
  exit 1
fi
